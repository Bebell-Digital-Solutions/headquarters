
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Headquarters</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script> 
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #df1783;
            --secondary: #8c318f;
            --accent: rgba(255,255,255,0.1);
            --light: #f8f9fa;
            --dark-bg: #1a202c;
            --dark-card: #2d3748;
            --dark-text: #e2e8f0;
        }

        html.dark {
            --light: var(--dark-bg);
            --dark-text: #e2e8f0;
        }




        .custom-image-widget {
            position: fixed !important;
            top: 50px !important;
            margin: 0 !important;
            padding: 0 !important;
            right: 0px;
            z-index: 999;
        }
        
        .custom-image {
            width: 70px;
            height: auto;
            transition: transform 0.2s;
        }
        
        .custom-image-widget:hover .custom-image {
            transform: scale(1.2);
        }
        
        .custom-image-widget:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
                
        



        

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            min-height: 100vh;
            background-color: #eef2f7;
            color: #333;
        }

        html.dark body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .nav-item {
            transition: all 0.3s;
        }

        .nav-item:hover {
            background-color: var(--accent);
        }

        .nav-item.active {
            background-color: var(--accent);
            font-weight: bold;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        html.dark .card {
            background: var(--dark-card);
        }

        input, select, textarea {
            background-color: #fbfbfb;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            color: #333;
            transition: all 0.2s;
        }
        html.dark input, html.dark select, html.dark textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: var(--dark-text);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(223, 23, 131, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            cursor: pointer;
            border: none;
            padding: 10px 20px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
        }
        html.dark .calendar-grid { background-color: #4a5568; }

        .calendar-day, .calendar-header {
            background-color: white;
            padding: 8px;
        }
        html.dark .calendar-day, html.dark .calendar-header { background-color: var(--dark-card); }
        .calendar-header { font-weight: bold; text-align: center; }

        .calendar-day { min-height: 120px; }
        .calendar-day.other-month { background-color: #f1f5f9; }
        html.dark .calendar-day.other-month { background-color: #1a202c; color: #718096; }

        .calendar-task {
            background-color: #fecdd3;
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }
        html.dark .calendar-task { background-color: #b91c1c; color: white; }

        /* Modal Styles */
        #modal-container {
            transition: opacity 0.3s ease;
        }
        #modal-content {
            transition: transform 0.3s ease;
        }

        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #22c55e;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .save-notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .section-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 14px;
        }
        html.dark .section-footer {
            border-top-color: #4a5568;
            color: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg flex">



     <div class="custom-image-widget" style="position: relative; display: inline-block;"> <!-- ADD THESE STYLES -->
    <a href="https://bebell-digital-solutions.github.io/headquarters/english-v03">
        <img class="custom-image" 
             src="https://bucket.mlcdn.com/a/3336/3336910/images/2891bb0a192c808fe1bb53e3905fc787957c2085.png" 
             alt="English Translation"
             style="display: block;"> <!-- Ensure image is block-level -->
    </a>

</div>



    

    <!-- Sidebar -->
    <div class="sidebar w-64 flex-shrink-0 flex flex-col p-6">
        <div class="mb-10">
            <div class="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mb-4">
                <i data-lucide="blocks" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Headquarters</h1>
            <p class="text-white/80 text-sm leading-relaxed">Tu centro de comando de productividad.</p>
        </div>
        
        <nav class="flex-grow space-y-2">
            <div id="nav-dashboard" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="dashboard"><i data-lucide="layout-dashboard"></i><span>Panel</span></div>
            <div id="nav-tasks" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="tasks"><i data-lucide="check-square"></i><span>Tareas</span></div>
            <div id="nav-projects" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="projects"><i data-lucide="folder-kanban"></i><span>Proyectos</span></div>
            <div id="nav-notes" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="notes"><i data-lucide="notebook-pen"></i><span>Notas</span></div>
            <div id="nav-calendar" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer" data-view="calendar"><i data-lucide="calendar-days"></i><span>Calendario</span></div>
        </nav>

        <div class="space-y-3 mt-auto">
            <button id="theme-toggle" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent text-left">
                <i data-lucide="sun" class="w-5 h-5"></i><span>Modo Claro</span>
            </button>
            <a href="https://www.notion.so/templates" target="_blank" class="flex items-center gap-3 px-4 py-3 rounded-lg cursor-pointer hover:bg-accent">
                 <i data-lucide="download" class="w-5 h-5"></i><span>Plantillas de Notion</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow p-8 overflow-y-auto">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section space-y-8">
            <div>
                <h1 class="text-4xl font-bold">Panel de Control</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">Aqu√≠ est√° tu resumen de productividad para hoy.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button id="btn-add-task" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> A√±adir Nueva Tarea
                </button>
                <button id="btn-add-note" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> A√±adir Nota R√°pida
                </button>
                <button id="btn-add-project" class="btn btn-primary text-lg font-semibold p-6">
                    <i data-lucide="plus-circle"></i> A√±adir Nuevo Proyecto
                </button>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                <!-- Las estad√≠sticas se renderizar√°n aqu√≠ por JS -->
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6 flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">Estado de Finalizaci√≥n de Tareas</h2>
                    <div class="relative flex-grow min-h-[250px]">
                        <canvas id="task-completion-chart"></canvas>
                    </div>
                </div>
                <a href="https://bebell-digital-solutions.github.io/aiba-deepseek/es-v03" target="_blank" class="card block hover:shadow-2xl transition-shadow duration-300 rounded-lg overflow-hidden">
                    <img src="https://bucket.mlcdn.com/a/3336/3336910/images/1c0e6f789ace683b250af917d451ea60b2454019.gif" alt="Equipo trabajando en un proyecto" class="object-cover w-full h-full">
                </a>
            </div>

            <div class="card p-6">
                 <h2 class="text-xl font-bold mb-4">Resumen de Tareas</h2>
                 <div id="dashboard-tasks" class="text-gray-600 dark:text-gray-300">Cargando tareas...</div>
            </div>

            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">Vista Previa del Calendario</h2>
                <div id="dashboard-calendar-preview">Cargando calendario...</div>
            </div>
        </section>

        <!-- Tasks Section -->
        <section id="tasks" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Tareas</h1>
                <button id="add-task-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> A√±adir Nueva Tarea
                </button>
            </div>
            <div id="tasks-filter-container" class="card p-4 mb-6"></div>
            <div id="tasks-list" class="space-y-4"></div>
        </section>

        <!-- Projects Section -->
        <section id="projects" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Proyectos</h1>
                 <button id="add-project-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> A√±adir Nuevo Proyecto
                </button>
            </div>
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Notes Section -->
        <section id="notes" class="section hidden">
             <div class="flex justify-between items-center mb-6">
                <h1 class="text-4xl font-bold">Notas</h1>
                 <button id="add-note-from-view" class="btn btn-primary">
                    <i data-lucide="plus"></i> A√±adir Nueva Nota
                </button>
            </div>
            <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Calendar Section -->
        <section id="calendar" class="section hidden space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-4xl font-bold">Calendario</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                         <button id="sync-google-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white text-sm py-2">
                            <i data-lucide="calendar-plus"></i> Sincronizar con Google
                        </button>
                        <button id="download-ics-btn" class="btn bg-green-500 hover:bg-green-600 text-white text-sm py-2">
                           <i data-lucide="download-cloud"></i> Descargar .ICS
                        </button>
                    </div>
                    <div class="flex items-center border rounded-lg p-1 bg-gray-200 dark:bg-gray-700">
                        <button id="calendar-view-month" class="px-3 py-1 text-sm rounded-md">Mes</button>
                        <button id="calendar-view-week" class="px-3 py-1 text-sm rounded-md">Semana</button>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">Tareas de Hoy</h2>
                <div id="calendar-today-tasks"></div>
            </div>

            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                     <button id="calendar-prev" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-left"></i></button>
                     <h2 id="calendar-title" class="text-2xl font-bold"></h2>
                     <button id="calendar-next" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="chevron-right"></i></button>
                </div>
                <div id="calendar-container"></div>
            </div>
        </section>
        
        <footer class="section-footer">
            <p>Desarrollado con üíñ por <strong style="color:var(--primary);">Bebell Digital Solutions</strong></p>
            <p>Copyright ¬© 2025 ‚Ä¢ Todos los derechos reservados</p>
        </footer>
    </main>

    <!-- Modal -->
    <div id="modal-container" class="fixed inset-0 z-50 bg-black/60 hidden items-center justify-center p-4 opacity-0">
        <div id="modal-content" class="card w-full max-w-2xl transform -translate-y-10">
            <div class="flex justify-between items-center p-4 border-b dark:border-gray-600">
                <h2 id="modal-title" class="text-2xl font-bold">T√≠tulo del Modal</h2>
                <button id="modal-close" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
            </div>
        </div>
    </div>

    <div class="save-notification" id="saveNotification">
        ¬°Datos guardados correctamente!
    </div>





<script>(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://api.helpdesk.icu/widget/6cb4c417-1da5-31ec-ae0d-b1f79dad581f?r=' + encodeURIComponent(window.location);
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'contactus-jssdk'));</script>


    
    
    <script>
        (function() {
            'use strict';

            // --- STATE MANAGEMENT & GLOBALS ---
            const state = {
                tasks: [],
                projects: [],
                notes: [],
                activeView: 'dashboard',
                calendarDate: new Date(),
                calendarView: 'month', // 'month' or 'week'
                taskSearchQuery: '',
                activeTagFilter: null,
            };
            let taskCompletionChart = null;

            // --- DATABASE SERVICE ---
            const dbService = {
                db: null,
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open('HeadquartersDB', 2);
                        request.onerror = e => reject('Error abriendo DB', e);
                        request.onsuccess = e => {
                            this.db = e.target.result;
                            resolve();
                        };
                        request.onupgradeneeded = e => {
                            const db = e.target.result;
                            const stores = ['tasks', 'projects', 'notes'];
                            stores.forEach(s => {
                                if (!db.objectStoreNames.contains(s)) {
                                    db.createObjectStore(s, { keyPath: 'id' });
                                }
                            });
                        };
                    });
                },
                async add(storeName, item) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Error de transacci√≥n en ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.put(item).onerror = e => reject(`Error al a√±adir/actualizar en ${storeName}`, e.target.error);
                    });
                },
                async getAll(storeName) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readonly');
                        const store = tx.objectStore(storeName);
                        const req = store.getAll();
                        req.onsuccess = e => resolve(e.target.result);
                        req.onerror = e => reject(`Error al obtener todo de ${storeName}`, e.target.error);
                    });
                },
                async delete(storeName, key) {
                    return new Promise((resolve, reject) => {
                        const tx = this.db.transaction(storeName, 'readwrite');
                        tx.oncomplete = () => resolve();
                        tx.onerror = e => reject(`Error de transacci√≥n en ${storeName}`, e.target.error);
                        const store = tx.objectStore(storeName);
                        store.delete(key).onerror = e => reject(`Error al eliminar en ${storeName}`, e.target.error);
                    });
                },
            };

            // --- DOM SELECTORS ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            // --- RENDER FUNCTIONS & HELPERS ---
            function getPriorityInfo(priority) {
                switch (priority) {
                    case 'p1': return { icon: 'chevrons-up', text: 'M√°xima', badge: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' };
                    case 'p2': return { icon: 'chevron-up', text: 'Alta', badge: 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300' };
                    case 'p3': return { icon: 'equal', text: 'Media', badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                    case 'p4': return { icon: 'chevron-down', text: 'Baja', badge: 'bg-gray-100 text-gray-700 dark:bg-gray-900 dark:text-gray-300' };
                    default: return { icon: 'equal', text: 'Media', badge: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' };
                }
            }

            function render() {
                $$('.section').forEach(el => el.classList.add('hidden'));
                $(`#${state.activeView}`).classList.remove('hidden');

                switch(state.activeView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'tasks': renderTasks(); break;
                    case 'projects': renderProjects(); break;
                    case 'notes': renderNotes(); break;
                    case 'calendar': renderCalendar(); break;
                }
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            function renderDashboard() {
                // Render Stats
                const statsContainer = $('#dashboard-stats');
                const pendingTasksCount = state.tasks.filter(t => !t.completed).length;
                const activeProjects = state.projects.length; 
                const totalNotes = state.notes.length;

                statsContainer.innerHTML = `
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full"><i data-lucide="list-checks" class="text-blue-500"></i></div>
                        <div><div class="text-2xl font-bold">${pendingTasksCount}</div><div class="text-gray-500 dark:text-gray-400">Tareas Pendientes</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-full"><i data-lucide="folder-kanban" class="text-purple-500"></i></div>
                        <div><div class="text-2xl font-bold">${activeProjects}</div><div class="text-gray-500 dark:text-gray-400">Proyectos Activos</div></div>
                    </div>
                    <div class="card p-4 flex items-center gap-4">
                        <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-full"><i data-lucide="notebook-pen" class="text-yellow-500"></i></div>
                        <div><div class="text-2xl font-bold">${totalNotes}</div><div class="text-gray-500 dark:text-gray-400">Notas Totales</div></div>
                    </div>
                `;

                // Render Doughnut Chart
                const completedTasks = state.tasks.filter(t => t.completed).length;
                const pendingChartTasks = state.tasks.length - completedTasks;
                
                if (taskCompletionChart) {
                    taskCompletionChart.destroy();
                }
                
                const chartCtx = $('#task-completion-chart').getContext('2d');
                taskCompletionChart = new Chart(chartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completadas', 'Pendientes'],
                        datasets: [{
                            data: [completedTasks, pendingChartTasks],
                            backgroundColor: ['#22c55e', '#ef4444'],
                            borderColor: document.documentElement.classList.contains('dark') ? '#2d3748' : '#ffffff',
                            borderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: document.documentElement.classList.contains('dark') ? '#e2e8f0' : '#333', padding: 20 }}},
                        cutout: '70%'
                    }
                });

                // Render Task Overview, sorted by priority
                const taskOverview = $('#dashboard-tasks');
                const incompleteTasks = state.tasks
                    .filter(t => !t.completed)
                    .sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));
                
                if (incompleteTasks.length > 0) {
                    taskOverview.innerHTML = incompleteTasks
                        .slice(0, 5)
                        .map(t => {
                            const priorityInfo = getPriorityInfo(t.priority);
                            return `
                                <div class="py-3 border-b dark:border-gray-700 flex justify-between items-center">
                                    <span>${t.title}</span>
                                    <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                        <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                        ${priorityInfo.text}
                                    </span>
                                </div>`;
                        })
                        .join('');
                } else {
                    taskOverview.innerHTML = '<p class="text-gray-500">No hay tareas pendientes. ¬°Buen trabajo!</p>';
                }

                // Render Calendar Preview
                const calendarPreview = $('#dashboard-calendar-preview');
                const upcomingTasks = state.tasks
                    .filter(t => !t.completed && t.dueDate && new Date(t.dueDate) >= new Date())
                    .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))
                    .slice(0, 3);
                if (upcomingTasks.length > 0) {
                    calendarPreview.innerHTML = upcomingTasks
                        .map(t => `<div class="py-2 border-b dark:border-gray-700">${t.title} - <span class="text-sm text-gray-500">${new Date(t.dueDate).toLocaleDateString('es-ES')}</span></div>`)
                        .join('');
                } else {
                    calendarPreview.innerHTML = '<p class="text-gray-500">No hay pr√≥ximos vencimientos.</p>';
                }
            }

            function renderTasks() {
                const list = $('#tasks-list');
                const filterContainer = $('#tasks-filter-container');

                // Render filter controls
                const allTags = [...new Set(state.tasks.flatMap(t => t.tags || []))].sort();
                filterContainer.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-grow">
                            <label for="task-search-input" class="sr-only">Buscar Tareas</label>
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                <input id="task-search-input" type="search" placeholder="Buscar tareas por t√≠tulo..." class="w-full p-2 pl-10 rounded-lg" value="${state.taskSearchQuery || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 flex-wrap">
                        <span class="font-semibold text-sm">Filtrar por Etiqueta:</span>
                        ${allTags.length > 0 ? allTags.map(tag => `<button class="tag-filter-btn px-3 py-1 text-sm rounded-full ${state.activeTagFilter === tag ? 'btn-primary' : 'bg-gray-200 dark:bg-gray-700'}" data-tag="${tag}">${tag}</button>`).join('') : '<span class="text-sm text-gray-500">A√∫n no hay etiquetas.</span>'}
                        ${state.activeTagFilter ? `<button id="clear-tag-filter-btn" class="text-sm text-red-500 hover:underline">Limpiar Filtro</button>` : ''}
                    </div>
                `;

                // Filter tasks logic
                let filteredTasks = [...state.tasks];
                if (state.taskSearchQuery) {
                    const query = state.taskSearchQuery.toLowerCase();
                    filteredTasks = filteredTasks.filter(t => t.title.toLowerCase().includes(query) || (t.description && t.description.toLowerCase().includes(query)));
                }
                if (state.activeTagFilter) {
                    filteredTasks = filteredTasks.filter(t => t.tags && t.tags.includes(state.activeTagFilter));
                }
                
                const sortedTasks = filteredTasks.sort((a, b) => (a.priority || 'p3').localeCompare(b.priority || 'p3'));

                if(sortedTasks.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500">Ninguna tarea coincide con tus criterios.</div>`;
                    return;
                }
                list.innerHTML = sortedTasks.map(task => {
                    const priorityInfo = getPriorityInfo(task.priority);
                    const project = task.projectId ? state.projects.find(p=>p.id === task.projectId) : null;
                    return `
                    <div class="card p-4 flex items-start gap-4" data-task-id="${task.id}">
                        <button class="task-complete-btn mt-1 flex-shrink-0">
                            <i data-lucide="${task.completed ? 'check-circle-2' : 'circle'}" class="w-6 h-6 ${task.completed ? 'text-green-500' : 'text-gray-400'}"></i>
                        </button>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</h3>
                                <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${priorityInfo.badge}">
                                    <i data-lucide="${priorityInfo.icon}" class="w-3 h-3"></i>
                                    ${priorityInfo.text}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${task.description || ''}</p>
                            <div class="flex items-center gap-4 text-sm text-gray-500 mt-3 flex-wrap">
                                ${task.dueDate ? `<div class="flex items-center gap-1.5"><i data-lucide="calendar" class="w-4 h-4"></i> ${new Date(task.dueDate).toLocaleDateString('es-ES')}</div>` : ''}
                                ${project ? `<div class="flex items-center gap-1.5"><i data-lucide="folder-kanban" class="w-4 h-4"></i> ${project.name}</div>` : ''}
                                ${task.urgency ? `<div class="flex items-center gap-1.5 text-red-600"><i data-lucide="clock" class="w-4 h-4"></i> Urgente</div>` : ''}
                                ${task.importance ? `<div class="flex items-center gap-1.5 text-yellow-600"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Importante</div>` : ''}
                            </div>
                             ${task.tags && task.tags.length > 0 ? `<div class="mt-3 flex flex-wrap gap-2">${task.tags.map(tag => `<span class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full">${tag}</span>`).join('')}</div>` : ''}
                        </div>
                        <div class="flex-shrink-0 flex gap-1">
                            <button class="task-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="task-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>`
                }).join('');
            }

            function renderProjects() {
                const list = $('#projects-list');
                if(state.projects.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">A√∫n no hay proyectos. ¬°A√±ade uno para empezar!</div>`;
                    return;
                }
                list.innerHTML = state.projects.map(p => `
                    <div class="card p-6 flex flex-col" data-project-id="${p.id}">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg mb-2 text-primary">${p.name}</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm">${p.description || 'Sin descripci√≥n.'}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t dark:border-gray-700 flex justify-end gap-2">
                            <button class="project-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="project-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>
                `).join('');
            }
            
            function renderNotes() {
                const list = $('#notes-list');
                if(state.notes.length === 0) {
                    list.innerHTML = `<div class="card p-6 text-center text-gray-500 col-span-full">A√∫n no hay notas. ¬°A√±ade una para empezar!</div>`;
                    return;
                }
                list.innerHTML = state.notes.map(n => `
                    <div class="card p-6 flex flex-col" data-note-id="${n.id}">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg mb-2">${n.title}</h3>
                            <p class="text-gray-600 dark:text-gray-300 whitespace-pre-wrap text-sm">${n.content || ''}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t dark:border-gray-700 flex justify-end gap-2">
                            <button class="note-edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                            <button class="note-delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            function updateCalendarViewToggle() {
                const monthBtn = $('#calendar-view-month');
                const weekBtn = $('#calendar-view-week');
                const activeClasses = ['bg-white', 'dark:bg-gray-500', 'shadow'];
                const inactiveClasses = ['bg-transparent', 'dark:bg-transparent', 'shadow-none'];

                if (state.calendarView === 'month') {
                    monthBtn.classList.add(...activeClasses);
                    monthBtn.classList.remove(...inactiveClasses);
                    weekBtn.classList.add(...inactiveClasses);
                    weekBtn.classList.remove(...activeClasses);
                } else {
                    weekBtn.classList.add(...activeClasses);
                    weekBtn.classList.remove(...inactiveClasses);
                    monthBtn.classList.add(...inactiveClasses);
                    monthBtn.classList.remove(...activeClasses);
                }
            }

            function renderMonthlyCalendar() {
                const calContainer = $('#calendar-container');
                const calTitle = $('#calendar-title');
                const date = state.calendarDate;
                calTitle.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

                const month = date.getMonth();
                const year = date.getFullYear();

                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startingDay = firstDayOfMonth.getDay();

                let gridHtml = '<div class="calendar-grid">';
                'Dom,Lun,Mar,Mi√©,Jue,Vie,S√°b'.split(',').forEach(day => {
                    gridHtml += `<div class="calendar-header">${day}</div>`;
                });

                for (let i = 0; i < startingDay; i++) {
                    gridHtml += '<div class="calendar-day other-month"></div>';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDate = new Date(year, month, i);
                    dayDate.setHours(0, 0, 0, 0);
                    const tasksOnDay = state.tasks.filter(t => {
                        if (!t.dueDate) return false;
                        const taskDate = new Date(t.dueDate);
                        taskDate.setHours(0, 0, 0, 0);
                        return taskDate.getTime() === dayDate.getTime();
                    });

                    let tasksHtml = tasksOnDay.map(t => `<div class="calendar-task text-xs p-1 my-1 rounded-md truncate" title="${t.title}">${t.title}</div>`).join('');
                    
                    gridHtml += `<div class="calendar-day">
                        <div class="font-bold text-right">${i}</div>
                        ${tasksHtml}
                    </div>`;
                }
                gridHtml += '</div>';
                calContainer.innerHTML = gridHtml;
            }

            function renderWeeklyCalendar() {
                const calContainer = $('#calendar-container');
                const calTitle = $('#calendar-title');
                const date = new Date(state.calendarDate);

                // Find Sunday of the current week
                const firstDayOfWeek = new Date(date);
                firstDayOfWeek.setDate(date.getDate() - date.getDay());
                
                // Find Saturday of the current week
                const lastDayOfWeek = new Date(firstDayOfWeek);
                lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);

                const options = { month: 'long', day: 'numeric' };
                calTitle.textContent = `${firstDayOfWeek.toLocaleDateString('es-ES', options)} - ${lastDayOfWeek.toLocaleDateString('es-ES', { ...options, year: 'numeric' })}`;

                let gridHtml = '<div class="calendar-grid">';
                'Dom,Lun,Mar,Mi√©,Jue,Vie,S√°b'.split(',').forEach(day => {
                    gridHtml += `<div class="calendar-header">${day}</div>`;
                });

                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(firstDayOfWeek);
                    currentDay.setDate(firstDayOfWeek.getDate() + i);
                    currentDay.setHours(0, 0, 0, 0);
                    
                    const tasksOnDay = state.tasks.filter(t => {
                        if (!t.dueDate) return false;
                        const taskDate = new Date(t.dueDate);
                        taskDate.setHours(0, 0, 0, 0);
                        return taskDate.getTime() === currentDay.getTime();
                    });
                    
                    let tasksHtml = tasksOnDay.map(t => `<div class="calendar-task text-xs p-1 my-1 rounded-md truncate" title="${t.title}">${t.title}</div>`).join('');
                    
                    gridHtml += `<div class="calendar-day">
                        <div class="font-bold text-right">${currentDay.getDate()}</div>
                        ${tasksHtml}
                    </div>`;
                }
                gridHtml += '</div>';
                calContainer.innerHTML = gridHtml;
            }

            function renderCalendar() {
                const todayTasksContainer = $('#calendar-today-tasks');
                
                updateCalendarViewToggle();
                if (state.calendarView === 'month') {
                    renderMonthlyCalendar();
                } else {
                    renderWeeklyCalendar();
                }

                // Render Today's Tasks (common for both views)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todaysTasks = state.tasks.filter(t => {
                    if (!t.dueDate) return false;
                    const taskDate = new Date(t.dueDate);
                    taskDate.setHours(0, 0, 0, 0);
                    return taskDate.getTime() === today.getTime();
                });
                
                if (todaysTasks.length > 0) {
                    todayTasksContainer.innerHTML = todaysTasks.map(t => `<div class="p-2 rounded-md ${t.completed ? 'bg-green-100 dark:bg-green-900' : 'bg-blue-100 dark:bg-blue-900'}">${t.title}</div>`).join('<div class="my-2"></div>');
                } else {
                    todayTasksContainer.innerHTML = '<p class="text-gray-500">No hay tareas programadas para hoy.</p>';
                }
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
            
            // --- MODAL & FORM LOGIC ---
            function openModal(title, content) {
                $('#modal-title').textContent = title;
                $('#modal-body').innerHTML = content;
                $('#modal-container').classList.remove('hidden');
                $('#modal-container').classList.add('flex');
                setTimeout(() => {
                    $('#modal-container').classList.remove('opacity-0');
                    $('#modal-content').classList.remove('-translate-y-10');
                }, 10);
                if (window.lucide) {
                    lucide.createIcons();
                }
            }

            function closeModal() {
                $('#modal-content').classList.add('-translate-y-10');
                $('#modal-container').classList.add('opacity-0');
                setTimeout(() => {
                    $('#modal-container').classList.add('hidden');
                    $('#modal-container').classList.remove('flex');
                }, 300);
            }

            function getTaskFormHtml(task = {}) {
                const isNew = !task.id;
                const projectsOptions = state.projects.map(p => `<option value="${p.id}" ${task.projectId === p.id ? 'selected' : ''}>${p.name}</option>`).join('');
                return `
                    <form id="task-form" class="space-y-4" data-task-id="${task.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">T√≠tulo</label>
                            <input name="title" required class="w-full p-2" value="${task.title || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Descripci√≥n</label>
                            <textarea name="description" class="w-full p-2" rows="3">${task.description || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label class="font-semibold block mb-1">Fecha de Vencimiento</label>
                                <input name="dueDate" type="date" class="w-full p-2" value="${task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : ''}">
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">Proyecto</label>
                                <select name="projectId" class="w-full p-2">
                                    <option value="">Ninguno</option>
                                    ${projectsOptions}
                                </select>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                             <div>
                                <label class="font-semibold block mb-1">Prioridad</label>
                                <select name="priority" class="w-full p-2">
                                   <option value="p1" ${task.priority === 'p1' ? 'selected' : ''}>üî• M√°xima</option>
                                   <option value="p2" ${task.priority === 'p2' ? 'selected' : ''}>‚ö†Ô∏è Alta</option>
                                   <option value="p3" ${!task.priority || task.priority === 'p3' ? 'selected':''}>üîµ Media</option>
                                   <option value="p4" ${task.priority === 'p4' ? 'selected' : ''}>‚¨áÔ∏è Baja</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">Urgencia</label>
                                <select name="urgency" class="w-full p-2">
                                   <option value="true" ${task.urgency ? 'selected' : ''}>‚è∞ Urgente</option>
                                   <option value="false" ${!task.urgency ? 'selected' : ''}>No Urgente</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-semibold block mb-1">Importancia</label>
                                <select name="importance" class="w-full p-2">
                                   <option value="true" ${task.importance ? 'selected' : ''}>‚ö†Ô∏è Importante</option>
                                   <option value="false" ${!task.importance ? 'selected' : ''}>No Importante</option>
                                </select>
                            </div>
                        </div>
                         <div>
                            <label class="font-semibold block mb-1">Etiquetas (separadas por coma)</label>
                            <input name="tags" class="w-full p-2" placeholder="ej: trabajo, personal, seguimiento" value="${(task.tags || []).join(', ')}">
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">Cancelar</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'A√±adir Tarea' : 'Guardar Cambios'}</button>
                        </div>
                    </form>
                `;
            }

            function getProjectFormHtml(project = {}) {
                const isNew = !project.id;
                 return `
                    <form id="project-form" class="space-y-4" data-project-id="${project.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">Nombre del Proyecto</label>
                            <input name="name" required class="w-full p-2" value="${project.name || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Descripci√≥n</label>
                            <textarea name="description" class="w-full p-2" rows="4">${project.description || ''}</textarea>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">Cancelar</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'A√±adir Proyecto' : 'Guardar Cambios'}</button>
                        </div>
                    </form>
                `;
            }

            function getNoteFormHtml(note = {}) {
                const isNew = !note.id;
                 return `
                    <form id="note-form" class="space-y-4" data-note-id="${note.id || ''}">
                        <div>
                            <label class="font-semibold block mb-1">T√≠tulo</label>
                            <input name="title" required class="w-full p-2" value="${note.title || ''}">
                        </div>
                        <div>
                            <label class="font-semibold block mb-1">Contenido</label>
                            <textarea name="content" class="w-full p-2" rows="8">${note.content || ''}</textarea>
                        </div>
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" id="modal-cancel" class="btn bg-gray-200 dark:bg-gray-600 dark:text-white">Cancelar</button>
                            <button type="submit" class="btn btn-primary">${isNew ? 'A√±adir Nota' : 'Guardar Cambios'}</button>
                        </div>
                    </form>
                `;
            }
            
            async function handleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                let item, storeName;

                switch(form.id) {
                    case 'task-form':
                        storeName = 'tasks';
                        const taskId = form.dataset.taskId;
                        const existingTask = taskId ? state.tasks.find(t => t.id === taskId) : {};
                        const tagsRaw = formData.get('tags') || '';
                        item = {
                            ...existingTask,
                            id: taskId || `task_${Date.now()}`,
                            createdAt: taskId ? existingTask.createdAt : Date.now(),
                            completed: existingTask.completed || false,
                            title: formData.get('title'),
                            description: formData.get('description'),
                            dueDate: formData.get('dueDate') ? new Date(formData.get('dueDate')+'T00:00:00').getTime() : null,
                            projectId: formData.get('projectId'),
                            priority: formData.get('priority'),
                            urgency: formData.get('urgency') === 'true',
                            importance: formData.get('importance') === 'true',
                            tags: tagsRaw.split(',').map(t => t.trim()).filter(t => t),
                        };
                        break;
                    case 'project-form':
                        storeName = 'projects';
                        const projectId = form.dataset.projectId;
                        const existingProject = projectId ? state.projects.find(p => p.id === projectId) : {};
                        item = {
                            ...existingProject,
                            id: projectId || `project_${Date.now()}`,
                            createdAt: projectId ? existingProject.createdAt : Date.now(),
                            name: formData.get('name'),
                            description: formData.get('description'),
                        };
                        break;
                    case 'note-form':
                        storeName = 'notes';
                        const noteId = form.dataset.noteId;
                        const existingNote = noteId ? state.notes.find(n => n.id === noteId) : {};
                        item = {
                            ...existingNote,
                            id: noteId || `note_${Date.now()}`,
                            createdAt: noteId ? existingNote.createdAt : Date.now(),
                            title: formData.get('title'),
                            content: formData.get('content'),
                        };
                        break;
                }

                if(item && storeName) {
                    await dbService.add(storeName, item);
                    await refreshState();
                    render();
                    closeModal();
                }
            }

            // --- EVENT HANDLERS ---
            function handleNavClick(e) {
                const navItem = e.target.closest('.nav-item');
                if (!navItem) return;

                state.activeView = navItem.dataset.view;
                
                $$('.nav-item').forEach(el => el.classList.remove('active'));
                navItem.classList.add('active');
                
                render();
            }

            async function handleTaskActions(e) {
                const taskCard = e.target.closest('.card[data-task-id]');
                if (!taskCard) return;
                const taskId = taskCard.dataset.taskId;

                // Complete toggle
                if (e.target.closest('.task-complete-btn')) {
                    const task = state.tasks.find(t => t.id === taskId);
                    if(task) {
                        task.completed = !task.completed;
                        task.completedAt = task.completed ? Date.now() : null;
                        await dbService.add('tasks', task);
                        await refreshState();
                        render();
                    }
                }
                
                // Edit button
                if (e.target.closest('.task-edit-btn')) {
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task) {
                        openModal('Editar Tarea', getTaskFormHtml(task));
                    }
                }

                // Delete button
                if (e.target.closest('.task-delete-btn')) {
                    if(confirm('¬øEst√°s seguro de que quieres eliminar esta tarea?')) {
                        await dbService.delete('tasks', taskId);
                        await refreshState();
                        render();
                    }
                }
            }
            
            async function handleProjectActions(e) {
                const projectCard = e.target.closest('.card[data-project-id]');
                if (!projectCard) return;
                const projectId = projectCard.dataset.projectId;

                if (e.target.closest('.project-edit-btn')) {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        openModal('Editar Proyecto', getProjectFormHtml(project));
                    }
                }

                if (e.target.closest('.project-delete-btn')) {
                    if (confirm('¬øEst√°s seguro de que quieres eliminar este proyecto? Esto quitar√° el proyecto de todas las tareas asociadas, pero no eliminar√° las tareas en s√≠.')) {
                        // Unlink tasks from this project
                        const tasksToUpdate = state.tasks.filter(t => t.projectId === projectId);
                        for (const task of tasksToUpdate) {
                            task.projectId = '';
                            await dbService.add('tasks', task);
                        }

                        await dbService.delete('projects', projectId);
                        await refreshState();
                        render();
                    }
                }
            }

            async function handleNoteActions(e) {
                const noteCard = e.target.closest('.card[data-note-id]');
                if (!noteCard) return;
                const noteId = noteCard.dataset.noteId;

                if (e.target.closest('.note-edit-btn')) {
                    const note = state.notes.find(n => n.id === noteId);
                    if (note) {
                        openModal('Editar Nota', getNoteFormHtml(note));
                    }
                }

                if (e.target.closest('.note-delete-btn')) {
                    if (confirm('¬øEst√°s seguro de que quieres eliminar esta nota?')) {
                        await dbService.delete('notes', noteId);
                        await refreshState();
                        render();
                    }
                }
            }

            function openGoogleSyncModal() {
                const tasksWithDates = state.tasks.filter(t => t.dueDate);
                let modalContent;
                if (tasksWithDates.length > 0) {
                    modalContent = tasksWithDates.map(task => `
                        <div class="flex justify-between items-center p-3 border-b dark:border-gray-700">
                            <div>
                                <div class="font-semibold">${task.title}</div>
                                <div class="text-sm text-gray-500">${new Date(task.dueDate).toLocaleDateString('es-ES')}</div>
                            </div>
                            <button class="add-to-google-btn btn btn-primary text-sm py-1 px-3" data-task-id="${task.id}">
                               <i data-lucide="plus" class="w-4 h-4"></i> A√±adir a Google
                            </button>
                        </div>
                    `).join('');
                } else {
                    modalContent = `<p class="text-gray-500 text-center p-4">No tienes tareas con fecha de vencimiento para sincronizar.</p>`;
                }
                openModal('Sincronizar Tareas con Google Calendar', modalContent);
            }

            function handleAddToGoogle(e) {
                const button = e.target.closest('.add-to-google-btn');
                if (!button) return;

                const taskId = button.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                if (!task || !task.dueDate) return;

                function toGoogleDate(date) {
                    return new Date(date).toISOString().replace(/-|:|\.\d{3}/g, '').split('T')[0];
                }

                const googleDate = toGoogleDate(task.dueDate);

                const url = new URL('https://www.google.com/calendar/render');
                url.searchParams.set('action', 'TEMPLATE');
                url.searchParams.set('text', task.title);
                url.searchParams.set('dates', `${googleDate}/${googleDate}`); // All-day event
                url.searchParams.set('details', task.description || 'Tarea desde Headquarters');
                
                window.open(url.toString(), '_blank');
            }


            function setupEventListeners() {
                // Navigation
                $('.sidebar nav').addEventListener('click', handleNavClick);
                
                // List actions (delegated)
                $('#tasks-list').addEventListener('click', handleTaskActions);
                $('#projects-list').addEventListener('click', handleProjectActions);
                $('#notes-list').addEventListener('click', handleNoteActions);

                // Task Filter actions (delegated)
                $('#tasks').addEventListener('input', e => {
                    if (e.target.id === 'task-search-input') {
                        state.taskSearchQuery = e.target.value;
                        renderTasks();
                    }
                });
                $('#tasks').addEventListener('click', e => {
                    if (e.target.matches('.tag-filter-btn')) {
                        const tag = e.target.dataset.tag;
                        state.activeTagFilter = state.activeTagFilter === tag ? null : tag;
                        renderTasks();
                    }
                    if (e.target.matches('#clear-tag-filter-btn')) {
                        state.activeTagFilter = null;
                        renderTasks();
                    }
                });

                // Theme Toggle
                $('#theme-toggle').addEventListener('click', () => {
                    const html = document.documentElement;
                    html.classList.toggle('dark');
                    const isDark = html.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    $('#theme-toggle').innerHTML = `<i data-lucide="${isDark ? 'moon' : 'sun'}"></i><span>${isDark ? 'Modo Oscuro' : 'Modo Claro'}</span>`;
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                    if (state.activeView === 'dashboard') {
                        renderDashboard();
                    }
                });

                // Modal Controls
                $('#modal-container').addEventListener('click', (e) => {
                    if (e.target.id === 'modal-container' || e.target.id === 'modal-cancel' || e.target.closest('#modal-close')) {
                        closeModal();
                    }
                });
                $('#modal-body').addEventListener('click', handleAddToGoogle); // Delegated listener for google sync buttons

                document.addEventListener('submit', (e) => {
                    if (e.target.matches('#task-form, #project-form, #note-form')) {
                        handleFormSubmit(e);
                    }
                });
                
                // "Add" buttons
                $('#btn-add-task').addEventListener('click', () => openModal('A√±adir Nueva Tarea', getTaskFormHtml()));
                $('#add-task-from-view').addEventListener('click', () => openModal('A√±adir Nueva Tarea', getTaskFormHtml()));

                $('#btn-add-project').addEventListener('click', () => openModal('A√±adir Nuevo Proyecto', getProjectFormHtml()));
                $('#add-project-from-view').addEventListener('click', () => openModal('A√±adir Nuevo Proyecto', getProjectFormHtml()));
                
                $('#btn-add-note').addEventListener('click', () => openModal('A√±adir Nueva Nota', getNoteFormHtml()));
                $('#add-note-from-view').addEventListener('click', () => openModal('A√±adir Nueva Nota', getNoteFormHtml()));

                // Calendar Controls
                $('#calendar-prev').addEventListener('click', () => {
                    if (state.calendarView === 'month') {
                        state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
                    } else {
                        state.calendarDate.setDate(state.calendarDate.getDate() - 7);
                    }
                    renderCalendar();
                });
                $('#calendar-next').addEventListener('click', () => {
                    if (state.calendarView === 'month') {
                        state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
                    } else {
                        state.calendarDate.setDate(state.calendarDate.getDate() + 7);
                    }
                    renderCalendar();
                });
                $('#calendar-view-month').addEventListener('click', () => {
                    state.calendarView = 'month';
                    renderCalendar();
                });
                $('#calendar-view-week').addEventListener('click', () => {
                    state.calendarView = 'week';
                    renderCalendar();
                });

                // ICS Download & Google Sync
                $('#download-ics-btn').addEventListener('click', downloadICS);
                $('#sync-google-btn').addEventListener('click', openGoogleSyncModal);
            }

            function downloadICS() {
                let ics_content = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Headquarters//EN
`;
                state.tasks.forEach(task => {
                    if(task.dueDate) {
                        const startDate = new Date(task.dueDate).toISOString().replace(/-|:|\.\\d\\d\\d/g,"");
                        ics_content += `BEGIN:VEVENT
UID:${task.id}@headquarters
DTSTAMP:${new Date().toISOString().replace(/-|:|\.\\d\\d\\d/g,"")}
DTSTART;VALUE=DATE:${startDate.substring(0,8)}
SUMMARY:${task.title}
DESCRIPTION:${task.description || ''}
END:VEVENT
`
                    }
                });
                ics_content += 'END:VCALENDAR';

                const blob = new Blob([ics_content], {type: 'text/calendar;charset=utf-8'});
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "headquarters_tareas.ics";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }
            
            async function refreshState() {
                try {
                    [state.tasks, state.projects, state.notes] = await Promise.all([
                        dbService.getAll('tasks'),
                        dbService.getAll('projects'),
                        dbService.getAll('notes'),
                    ]);
                    // Default sort can be by creation date
                    state.tasks.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                    state.projects.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                    state.notes.sort((a,b) => (a.createdAt > b.createdAt) ? -1 : 1);
                } catch(e) {
                    console.error("No se pudo actualizar el estado desde la DB", e);
                }
            }

            // --- INITIALIZATION ---
            async function init() {
                // Set initial theme
                const theme = localStorage.getItem('theme');
                const isDark = theme === 'dark' || (theme === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) {
                    document.documentElement.classList.add('dark');
                }
                $('#theme-toggle').innerHTML = `<i data-lucide="${isDark ? 'moon' : 'sun'}"></i><span>${isDark ? 'Modo Oscuro' : 'Modo Claro'}</span>`;
                
                if (window.lucide) {
                   lucide.createIcons();
                }

                setupEventListeners();
                
                try {
                    await dbService.init();
                    await refreshState();
                    render();
                } catch(e) {
                    console.error("Fall√≥ la inicializaci√≥n", e);
                    $('main').innerHTML = `<div class="text-red-500 p-8">Error: No se pudo inicializar la aplicaci√≥n. Por favor, revisa la consola para m√°s detalles.</div>`;
                }
            }

            document.addEventListener('DOMContentLoaded', init);

        })();
    </script>
</body>
</html>
